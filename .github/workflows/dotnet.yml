name: .NET

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build:

    runs-on: windows-latest

    steps:
    - name: Checkout Repo
      uses: actions/checkout@v4
      with:
        path: MeasureApp

    - name: Checkout Dependency Repo
      uses: actions/checkout@v4
      with:
        repository: crthu/carrotlink.net
        path: CarrotLink.NET

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    - name: Restore dependencies
      run: dotnet restore MeasureApp/MeasureApp
    
    - name: Build
      run: dotnet build MeasureApp/MeasureApp --no-restore --configuration Release
      
    - name: Test
      run: dotnet test MeasureApp/MeasureApp --no-build --verbosity normal --configuration Release

    - name: Publish App Files
      run: |
        dotnet publish MeasureApp/MeasureApp.csproj \
        -c Release \
        -o ${{ github.workspace }}/Publish \
        --no-build 
        
    - name: Extract Project Version
      id: extract_version 
      shell: pwsh 
      run: |
        $version = (Select-Xml -Path "MeasureApp/MeasureApp.csproj" -XPath "//AssemblyVersion").Node | Select-Object -First 1
        if (-not $version) {
            $version = "0.0.0-CI"
            Write-Host "⚠️ Warning: AssemblyVersion not found. Using fallback version: $version"
        }
        Write-Host "✅ Successfully extracted project version: $version"
        echo "project_version=$version" >> $env:GITHUB_OUTPUT
        
